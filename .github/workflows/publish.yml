name: ğŸš€ Build and Publish

on:
  # DÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:

  # DÃ©clenchement par un push sur la branche main
  push:
    branches:
      - main

jobs:
  # CrÃ©ation du build et publication du package
  build-and-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      pages: write

    outputs:
      VERSION_CHANGED: ${{ steps.check_version.outputs.VERSION_CHANGED }}

    steps:
      # 1. Installation
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 2. Tests et dÃ©ploiement du rapport de couverture
      - name: ğŸ“Š Generate test coverage
        run: npm run test:coverage

      - name: ğŸ›‚ Ensure badges directory exists
        run: mkdir -p badges

      - name: ğŸ¨ Create Coverage Badge
        uses: jaywcjlove/coverage-badges-cli@main
        with:
          source: coverage/coverage-summary.json
          output: badges/coverage.svg

      - name: ğŸ·ï¸ Deploy badge to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: badges
          target-folder: badges
          branch: gh-pages
          clean: false

      - name: ğŸ“„ Deploy coverage report to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: coverage/lcov-report
          target-folder: coverage
          branch: gh-pages
          clean: true
          clean-exclude: |
            storybook/**
            badges/**

      # 3. PrÃ©paration et dÃ©ploiement de la page d'accueil
      - name: ğŸ“„ Convert README to HTML
        run: |
          mkdir -p deploy_root
          cp README.md deploy_root/

          # Installation et utilisation de marked
          npm install -g marked
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>KUI Documentation</title><style>body{max-width:800px;margin:40px auto;padding:0 20px;font-family:system-ui,-apple-system,sans-serif}</style></head><body>" > deploy_root/index.html
          marked -i README.md >> deploy_root/index.html
          echo "</body></html>" >> deploy_root/index.html

      - name: ğŸ“¤ Deploy README to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: deploy_root
          target-folder: .
          clean: false

      # 4. VÃ©rification de la version et crÃ©ation du tag
      - name: ğŸ” Check if version changed
        id: check_version
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_NAME="v$PACKAGE_VERSION"

          # VÃ©rifier si le tag existe dÃ©jÃ 
          if git ls-remote --tags origin refs/tags/$TAG_NAME | grep -q $TAG_NAME; then
            echo "Version $PACKAGE_VERSION already published. Skipping."
            echo "VERSION_CHANGED=false" >> $GITHUB_OUTPUT
          else
            echo "New version $PACKAGE_VERSION detected."
            echo "VERSION=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
            echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "VERSION_CHANGED=true" >> $GITHUB_OUTPUT
          fi

      # 5. Build et publication du package
      - name: ğŸ—ï¸ Build package
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        run: npm run build

      - name: ğŸ·ï¸ Create and push tag
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # VÃ©rifier si le tag existe dÃ©jÃ 
          if ! git ls-remote --tags origin refs/tags/${{ steps.check_version.outputs.TAG_NAME }} | grep -q ${{ steps.check_version.outputs.TAG_NAME }}; then
            git tag ${{ steps.check_version.outputs.TAG_NAME }}
            git push origin ${{ steps.check_version.outputs.TAG_NAME }}
            echo "Tag ${{ steps.check_version.outputs.TAG_NAME }} created and pushed."
          else
            echo "Tag ${{ steps.check_version.outputs.TAG_NAME }} already exists. Skipping."
          fi

      # 6. CrÃ©ation de la release GitHub
      - name: ğŸ“ Create GitHub Release
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.check_version.outputs.TAG_NAME }}
          name: ${{ steps.check_version.outputs.TAG_NAME }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js for GitHub Packages
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"
          scope: "@kared-games"

      - name: ğŸ“¤ Publish to GitHub Packages
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        run: |
          echo "@kared-games:registry=https://npm.pkg.github.com/" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" >> .npmrc
          cat .npmrc
          npm publish --registry=https://npm.pkg.github.com/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. CrÃ©ation de la release NPM
      - name: ğŸ”§ Setup Node.js for NPM
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@kared"

      - name: ğŸ“¤ Publish to NPM
        if: steps.check_version.outputs.VERSION_CHANGED == 'true'
        run: |
          # Sauvegarde du package.json original
          cp package.json package.json.bak

          # Modification du nom pour npm
          jq '.name = "@kared/kui"' package.json > temp.json && mv temp.json package.json

          # Publication sur npm
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          npm publish --access public

          # Restauration du package.json original
          mv package.json.bak package.json
        env:
          NPM_TOKEN: ${{ secrets.NPM_PUBLISH_TOKEN }}

  # Appel au workflow de dÃ©ploiement Storybook
  deploy-storybook:
    needs: build-and-publish
    if: needs.build-and-publish.outputs.VERSION_CHANGED == 'true'
    uses: ./.github/workflows/deploy-storybook.yml
    with:
      version_changed: ${{ needs.build-and-publish.outputs.VERSION_CHANGED }}
    secrets: inherit
